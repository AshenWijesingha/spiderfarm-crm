{% extends 'sales/base.html' %}
{% load staticfiles %}
{% load paginate %}
{% load thumbnail %}
{% block extralinks %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
  .form-group label {
    font-weight: 800;
  }

  .add_opacity {
    opacity: 0.2;
  }

  .opacity_block {
    opacity: 0.2;
  }

</style>
{% endblock %}
{% block content %}
<!-- main_container starts here -->
<div class="main_container">


  <!--
  <div class="row marl">

    begin upload leads csv button row 
    <div class="col-lg-12 text-right">
      <span class="d-inline"><a class="primary_btn btn-info edit" data-toggle="modal" data-target="#uploadleadfile" data-backdrop="static" data-keyboard="false"
          href="#"><i class="fas fa-upload"></i>Upload Lead csv file</a></span>
      <span class="d-inline"><a class="primary_btn" href="{% url 'leads:add_lead'%}"><i class="fa fa-plus"></i> Add New
	      Lead</a></span>
    </div>
  </div>
   -->

  </div>
  <!-- heading_create ends here -->
  <div class="filter_row list_filter_row row marl" id="opacity_block">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body">
	  <form id="leads_filter" action="" method="POST">
	    <div class="card-body ">									            
	       <div class="card-title">Search</div>
                 <div class="row marl">

                  <div class="filter_col col-md-2"> 
                   <div class="form-group">
		     <label for="exampleInputEmail1">Domain</label>
                     <input type="text" class="form-control" name="domain_name"
                      value="{{request.POST.domain_name}}">
		     <label for="exampleInputEmail1">Name Server</label>
		     <input type="text" class="form-control" name="name_server"
		       value="{{request.POST.name_server}}" id="id_nameservers">		
		   </div>
                  </div>

                  <div class="filter_col col-md-2">
                    <div class="form-group">
	              <label for="exampleInputEmail1">Domain Expires</label>
                      <div class='input-group date' id='domain_expire_start'>
                        <input name="domain_expire_from" value={{ request.POST.domain_expire_from }} class="form-control" placeholder="Start Date" id="id_domain_expire_from" type="text">
                      </div>
		      <hr/>
                      <div class='input-group date' id='domain_expire_end'>
	                <input name="domain_expire_to" value={{ request.POST.domain_expire_to }} class="form-control" placeholder="End Date" id="id_domain_expire_to" type="text">
		      </div>
	            </div>
                  </div>

		  <div class="filter_col col-md-2">
                    <div class="form-group">
                    <label for="exampleInputEmail1">Status</label>
		      <select class="lead_status_multi form-control" id="id_lead_status" name="status" multiple="multiple">
		      {% for lead_status in status %}
		      <option value="{{ lead_status.0 }}" {% if lead_status in lead_obj.status %} selected=""{% endif %}>
		      {{ lead_status.1 }}</option>
		      {% endfor %}
                      </select>
		      <br>

		      <label for="exampleInputEmail1">Site IP</label>
                      <input type="text" class="form-control" name="site_ip"
		       value="{{request.POST.site_ip}}" id="id_site_ip">
                    </div>
		  </div>

                  <div class="filter_col col-md-2">
                    <div class="form-group form-group-lg">
                      <label for="exampleInputEmail1">SSL Expires</label>
                        <div class='input-group date' id='ssl_expire_start'>
                          <input name="ssl_expire_from" value={{ request.POST.ssl_expire_from }} class="form-control" placeholder="Start Date" id="id_ssl_expire_from" type="text">
                        </div>
			<hr/>
                        <div class='input-group date' id='ssl_expire_end'>
                          <input name="ssl_expire_to" value={{ request.POST.ssl_expire_to }} class="form-control" placeholder="End Date" id="id_ssl_expire_to" type="text">
                        </div>
                    </div>
                  </div>
              
		  <input type="hidden" name="tab_status" id="tab_status">
                  <div class="filter_col col-md-2">
                    <div class="form-group buttons_row float-right">
                      <button class="btn btn-primary" type="submit">Search</button>
                      <a href="{% url 'leads:list' %}" class="btn btn-default clear">Clear</a>
                    </div>
                  </div>
                  
		  
                  <div class="filter_col col-md-2">
                    <div class="form-group">
                      <label for="exampleInputEmail1">Assigned Users</label>
		        <select class="assigned_sales form-control" name="assigned_to" multiple="multiple">
                          {% for user in users %}
			  <option value="{{user.id}}" {% if user in lead_obj.assigned_to.all or user.id in assignedto_list %} selected="" {% endif %}>{{user.email}}</option>
		          {% endfor %}
		      </select>
		     </div>
		  </div>

		    <div class="filter_col col-md-2">
	             <div class="form-group">
	              <label for="exampleInputEmail1">Sort Expiration By</label>
		        <br>
			  <div class="btn-group btn-group-toggle" data-toggle="buttons">
		          {% if request.POST.sort_type %}
			   {% if request.POST.sort_type == "ssl" %}
			     <label class="btn btn-primary text-white active">
		             <input type="radio" name="sort_type" id="tgl_sort_ssl" autocomplete="off" value="{{ request.POST.sort_type }}" checked>
			   {% else %}
			     <label class="btn btn-primary text-white">
			     <input type="radio" name="sort_type" id="tgl_sort_ssl" autocomplete="off" value="ssl">
			   {% endif %}
			  {% else %}
			    <label class="btn btn-primary text-white">
			    <input type="radio" name="sort_type" id="tgl_sort_ssl" autocomplete="off" value="ssl">
                          {% endif %}
			   SSL
			  </label>
			  {% if request.POST.sort_type %}
			    {% if request.POST.sort_type == "domain" %}
		              <label class="btn btn-primary text-white active">							    <input type="radio" name="sort_type" id="tgl_sort_domain" autocomplete="off" value="{{ request.POST.sort_type }}" checked>
                             {% else %}
			      <label class="btn btn-primary text-white">
			      <input type="radio" name="sort_type" id="tgl_sort_domain" autocomplete="off" value="domain">
			    {% endif %}
			  {% else %}
			    <label class="btn btn-primary text-white">
			    <input type="radio" name="sort_type" id="tgl_sort_domain" autocomplete="off" value="domain">
			    {% endif %}
			    Domain
			    </label>
                   
                         <!-- start filter row -->
			 <div class="btn-group btn-group-toggle" data-toggle="buttons">
			 {% if request.POST.sort_order %}
			   {% if request.POST.sort_order == "asc" %}
			   <label class="btn btn-primary text-white active">
		           <input type="radio" name="sort_order" id="tgl_sort_asc" autocomplete="off" value="{{ request.POST.sort_order }}" checked>
			   {% else %}
			   <label class="btn btn-primary text-white">
			   <input type="radio" name="sort_order" id="tgl_sort_asc" autocomplete="off" value="asc">
			   {% endif %}
			   {% else %}
			   <label class="btn btn-primary text-white">
			  <input type="radio" name="sort_order" id="tgl_sort_asc" autocomplete="off" value="asc">	        {% endif %}
			  <i class="fa fa-sort-amount-up fa-inverse"></i>
			  </label>

			  {% if request.POST.sort_order %}
			    {% if request.POST.sort_order == "desc" %}
			    <label class="btn btn-primary text-white active">
			    <input type="radio" name="sort_order" id="tgl_sort_desc" autocomplete="off" value="{{ request.POST.sort_order }}" checked>
                          {% else %}
			  <label class="btn btn-primary text-white">
			  <input type="radio" name="sort_order" id="tgl_sort_desc" autocomplete="off" value="desc">
			  {% endif %}
			  {% else %}
			  <label class="btn btn-primary text-white">
			  <input type="radio" name="sort_order" id="tgl_sort_desc" autocomplete="off" value="desc">
			  {% endif %}
			  <i class="fa fa-sort-amount-down fa-inverse"></i>
			  </label>

                          </div>
			  </div> <!-- end form-group -->
                         </div>
			 <!-- end filter column -->	 
		</div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-12 col-lg-12 col-xl-12">
    <div class="table_container_row row marl no-gutters">
      <div class="col-md-12">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="open-tab" data-toggle="tab" href="#open" role="tab" aria-controls="open"
              aria-selected="true">Open ({{open_leads|length}})</a>
          </li>
	  <!--
          <li class="nav-item">
            <a class="nav-link" id="close-tab" data-toggle="tab" href="#close" role="tab" aria-controls="close"
              aria-selected="false">Closed ({{close_leads|length}})</a>
          </li>
	  -->
        </ul>
        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade show active" id="open" role="tabpanel" aria-labelledby="open">
            <div class="card">
              <div class="card-body">
                <div class="card-title text-right">
                  <span class="float-left">Open Leads - {% if show_pageitems %} {% show_pageitems %}{% else %}
                    {{ open_leads|length }}{% endif %}</span>
                  <span class="filter_toggle">
                    <a href="#" class="primary_btn"><i class="fas fa-filter"></i></a>
                  </span>
                </div>
                <div class="table-responsive">
                  <table class="table ">
                    <thead>
                      {% if open_leads|length > 0 %}
                      <tr>
			<th width="10%">Domain</th>
			<!-- <th width="5%">GeoIP</th> -->
			{% if "ADMIN" in request.user.role or "MANAGER" in request.user.role or request.user.is_superuser %}
                        <th width="15%">Assigned Sales</th>
			{% endif %}
                        <th width="15%">SSL Issuer</th>
                        <th width="15%">SSL Expires</th>
                        <th width="15%">Domain Expires</th>
                        <th width="10%">Status</th>
                      </tr>
                      {% endif %}
                    </thead>
                    <tbody>
                      {% if per_page %}
                      {% paginate per_page open_leads %}
                      {% else %}
                      {% paginate 15 open_leads %}
                      {% endif %}
                      {% for lead in open_leads %}
                      <tr class="text-center">

                        <td>
                          <a data-toggle="modal" data-target="#exampleModalCenter_lead{{lead.domain.id}}" href="#">
                            {{ lead.domain }}
                          </a>
                        </td>
                        
			{% if "ADMIN" in request.user.role or "MANAGER" in request.user.role or request.user.is_superuser %}
                        <td>
			   {% with lead_users=lead.assigned_to.all %}
                             {% if lead_users %}
                               {% for user in lead_users %}
                                 <span class="text-left">{{ user.email }}</span><br>
                               {% endfor %}
                             {% else %}
                                 Not Assigned
                             {% endif %}
                           {% endwith %}
                        </td>
			{% endif %}

                        <td>
			  {% with lead.domain.ssl_issuer_name.all|first as ssl_issuer %}
			    {{ ssl_issuer }}
			  {% endwith %}
                        </td>

                        <td>{{ lead.domain.ssl_expire }}</td>
			<td> {{ lead.domain.domain_expire }} </td>

			<td> {{ lead.status }}</td>
                
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {%ifequal open_leads|length 0%}
                <h6 class="text-center">No Open Lead Records Found</h6>
                {%endifequal%}
                <div class="marl row text-center">
                  {% show_pages %}
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="close" role="tabpanel" aria-labelledby="close">
            <div class="card">
              <div class="card-body">
                <div class="card-title text-right">
                  <span class="float-left">Closed Leads - {% if show_pageitems %} {% show_pageitems %}{% else %}
                    {{ close_leads|length }}{% endif %}</span>
                  <span class="filter_toggle">
                    <a href="#" class="primary_btn"><i class="fas fa-filter"></i></a>
                  </span>
                </div>
                <div class="table-responsive">
                  <table class="table ">
                    <thead>
                      {% if close_leads|length > 0 %}
                      <tr>
                        <th width="10%">Domain</th>
		        <!-- <th width="5%">IP</th> -->
                        <th width="10%">GeoIP Country</th>
                        <th width="5%">GeoIP Code</th>
                        <th width="20%">Assigned Sales</th>
                        <th width="10%">SSL Issuer</th>
                        <th width="10%">SSL Expires</th>
                        <th width="15%">Domain Expires</th>
                        <th width="10%">Actions</th>
                      </tr>
                      {% endif %}
                    </thead>
                    <tbody>
                      {% if per_page %}
                      {% paginate per_page close_leads %}
                      {% else %}
                      {% paginate 10 close_leads %}
                      {% endif %}
                      {% for lead in close_leads %}
                      <tr class="text-center">
                        <td scope="row">{{ forloop.counter }}</td>
                        <td><a href="#" data-toggle="modal" data-target="#exampleModalCenter_lead{{lead.domain.id}}">
                            {{ lead.title }}</a></td>
                        <td>{{ lead.source }}</td>
                        <td>{{ lead.get_status_display }}</td>
                        <td>
                          {% with lead_users=lead.assigned_to.all %}
                          {% for user in lead_users %}
                          {% if user.profile_pic %}
                          {% thumbnail user.profile_pic "40x40" crop="center" as im %}
                          <a href="{% url 'common:view_user' user.id %}">
                            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}"
                              title="{{ user.email }}">
                          </a>
                          {% endthumbnail %}
                          {% else %}
                          <a href="{% url 'common:view_user' user.id %}">
                            <img src="{% static 'images/user.png' %}" title="{{ user.email }}" width="40" height="40">
                          </a>
                          {% endif %}
                          {% empty %}
                          None
                          {% endfor %}
                          {% endwith %}
                        </td>
                        <td>
                          <div class="tag_content" id="leadtag{{lead.domain.id}}" data-leadTagContent="{{lead.domain.id}}">
                            {% with tags=lead.tags.all %}
                            {% if tags %}
                            {% for tag in tags %}
                            <span style="cursor: pointer;" class="tag_class_lead_" data-leadTag="{{lead.domain.id}}{{tag.id}}">
                              <span class="text-left color{{forloop.counter}}" id="list_tag">
                                <span data-link="{{tag.id}}" class="tag_class_lead">
                                  {{ tag.name }}
                                </span>
                                <span class="remove_tag" data-tag={{tag.id}} data-lead="{{lead.domain.id}}"><i
                                    class="fas fa-times" style="color: rgb(255, 255, 255);"></i></span>
                              </span>
                            </span>
                            {% endfor %}
                            <!-- <span title="Update Tags" data-toggle="modal" data-target=".modal_tags{{lead.domain.id}}"><i
                                  class="fas fa-pencil-alt"></i></span> -->
                            {% else %}
                            No Tags
                            {% endif %}
                            {% endwith %}
                            <!-- <span class="ml-2" title="Update Tags" data-toggle="modal"
                                  data-target=".modal_tags{{lead.domain.id}}"><i class="fas fa-plus"></i></span> -->
                          </div>
                        </td>
                        <td>{{ lead.country }}</td>
                        <td title="{{ lead.created_on_arrow }}">{{ lead.created_on_arrow }}</td>
                        <td class="actions">
                          <a href="{% url 'leads:view_lead' lead.domain.id %}" class="btn btn-info edit"><i
                              class="fas fa-eye"></i></a>

                          <!--<a href="{% url 'leads:remove_lead' lead.domain.id %}"
				  class="btn btn-danger delete remove_account"><i class="fas fa-trash-alt"></i></a>-->
                          
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {%ifequal close_leads|length 0%}
                <h6 class="text-center">No Closed Lead Records Found</h6>
                {%endifequal%}
                <div class="marl row text-center">
                  {% show_pages %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% for lead_record in open_leads %}

{% comment %}
<!-- modal for editing and deleting tags -->

<div class="modal fade bd-example-modal-lg modal_tags{{lead_record.id}}" tabindex="-1" role="dialog"
  aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="padding:20px 50px;">
        <h4><span class="glyphicon glyphicon-lock"></span>Update Tags</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px 50px;">
        <form role="form" id="" method="POST" action="{% url 'leads:update_lead_tags' lead_record.id %}">
          <div class="form-group">
            <label>Tags</label>
            <div class="txt-box-div" id="tag-div"><input type="text" name="tags" id="tags_1"
                value="{% for t in lead_record.tags.all %}{{t.name}}, {% endfor %}" class="tags tags_1" />
            </div>
          </div>
          <input type="hidden" name="full_path" value="{{request.get_full_path}}">
          <div class="text-center">
            <button id="" class="btn btn-success">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- modal for editing and deleting tags -->
{% endcomment %}

<div class="modal fade" id="exampleModalCenter_lead{{lead_record.domain.id}}" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        
	<div class="col-md-12">      
	 <div class="d-flex">
	   <div class="mr-auto p-2">
	      <h1 class="modal-title" id="exampleModalLongTitle"> <a href="{{lead_record.domain.domain_name}}" class="badge badge-dark">{{ lead_record.domain.domain_common }}</a></h1>
	      {% if lead_record.domain.redirect_url %}
	      <h6 id="exampleModalLongTitle">&nbsp;&nbsp;&nbsp;&nbsp;Redirects to <a href="{{lead_record.domain.redirect_url}}">{{lead_record.domain.redirect_url}}</a></h6>
	      {% endif %}
	   </div>
	   <div class="p-2">
		   <button type="button" class="btn btn-success" data-toggle="collapse" data-target="#collapse_edit_lead{{lead_record.domain.id}}" aria-expanded="false" aria-controls="collapse_edit_lead{{lead_record.domain.id}}"><i class="fas fa-pen"></i></button>
             <div class="btn-group">
	       <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		 <i class="fas fa-tools"></i></button>
	           <div class="dropdown-menu">
		   <a class="dropdown-item" href="https://{{lead_record.domain.domain_common}}.ipaddress.com/">IPAddress.com</a>
		   <div class="dropdown-divider"></div>
		   <a class="dropdown-item" href="https://builtwith.com/{{lead_record.domain.domain_common}}">BuiltWith.com</a>
		   <div class="dropdown-divider"></div>
		   <a class="dropdown-item" href="http://whois.domaintools.com/{{lead_record.domain.domain_common}}">WHOIS</a>
	           </div>
	     </div>
	   </div>
	 </div>
	</div>
       </div> <!-- end modal header -->


      <div class="modal-body m-0 p-0">
          <!-- ... -->
        <div class=" ">
	  <div class="card-header">
           <div class="col-md-12">
          
	   <div class="row">	   
              <div class="filter_col col-md-3">
		<div class="form-group">
	          <label class="lead_field_label" for="id_name" data-name="name">Name</label>
		  <hr/>
		  <div class="lead_field" id="lead_name{{lead_record.domain.id}}" data-name="name">
		  <h6>
	            {% if not lead_record.first_name and not lead_record.last_name %}
	              Not specified
	            {% else %}
	              {% if lead_record.first_name %}
		        {{ lead_record.first_name }}
	              {% endif %}
	              {% if lead_record.first_name %}
		        {{ lead_record.last_name }}
		      {% endif %}											  
		    {% endif %}
		  </div>
	        </div>
              </div>

	        <div class="filter_col col-md-3">
	          <div class="form-group">
	            <label class="lead_field_label" for="id_phone" data-name="name">Phone</label>
		    <hr/>
		       <div class="lead_field" id="lead_phone{{lead_record.domain.id}}" data-name="name">
	               <h6>
		       {% if not lead_record.phone %}
		         Not specified
		       {% else %}
		         {{ lead_record.phone }}
		       {% endif %}
		       </h6>
		       </div>
	          </div>
	        </div>

                <div class="filter_col col-md-3">
                  <div class="form-group">
		   <label class="lead_field_label" for="id_email" data-name="name">Email</label>
		   <hr/>
		     <div class="lead_field" id="lead_email{{lead_record.domain.id}}" data-name="name">
	             <h6>
	             {% if not lead_record.email %}
		       Not specified
		     {% else %}
		       {{ lead_record.email }}
		     {% endif %}
		     </h6>
		     </div>
		 </div>
                </div>

		<div class="filter_col col-md-3">
		    <div class="form-group">
		    <label class="lead_field_label" for="id_email" data-name="name">Tags</label>
		    </div>
		    <div class="form-group" id="lead_tags{{lead_record.domain.id}}">
		    <hr/>
		     
		    {% for t in lead_record.tags.all %}
		    <span class="badge badge-success">{{ t }}</span>
		    {% endfor %}
		    </div>  
                </div>
              </div>
	      <br>
	    </div>

	    <div class="collapse" id="collapse_edit_lead{{lead_record.domain.id}}">
	      <form id="lead_edit_form{{lead_record.domain.id}}" method="POST" action="" novalidate>
	       <div class="row">
	         <div class="col-md-3">
	           <input type="text" name="first_name" 
		   {% if lead_record.first_name %}
		     value="{{ lead_record.first_name }}" 
		   {% else %}
		     value=""
                   {% endif %}
		   class="form-control" placeholder="First Name" id="id_first_name{{lead_record.domain.id}}">
	         </div>
		 <div class="col-md-3">
                   <input type="text" name="phone" 
		   {% if lead_record.phone_number %}
		     value="{{ lead_record.phone_number }}" 
                   {% else %} 
		     value=""
                   {% endif %}
                   class="form-control" placeholder="Phone #" id="id_phone{{lead_record.domain.id}}">
		 </div>
		 <div class="col-md-3">
	           <input type="email" name="email" 
		   {% if lead_record.email %} 
		     value="{{ lead_record.email }}" 
		   {% else %}
		     value=""
                   {% endif %}
		   class="form-control" placeholder="Email" id="id_email{{lead_record.domain.id}}">
		 </div>
	       </div>
               <hr/>
               <div class="row">
	         <div class="col-md-3">
		   <input type="text" name="last_name" 
		   {% if lead_record.last_name %}
		     value="{{ lead_record.last_name }}" 
		   {% else %}
		     value=""
                   {% endif %}
		   class="form-control" placeholder="Last Name" id="id_last_name{{lead_record.domain.id}}">
		   <hr/>
		 </div>
	       </div>
	       <div class="row">
	         <div class="col-md-6">
	           <label for="exampleInputEmail1">Lead Status</label>
		   <select class="assigned_users form-control" id="id_status" name="status">
		     {% for lead_status in status %}
		     <option value="{{ lead_status.0 }}" {% if lead_status == lead_obj.status %} selected="" {% endif %}> {{ lead_status.1 }}</option>
		     {% endfor %}
		   </select>
		   <br>
		   {% if request.user.is_superuser or 'ADMIN' in request.user.role %}
		   <label for="exampleInputEmail1">Assigned Sales</label>
                   <select class="form-control" name="assigned_to">
		     <option></option>
		     {% for user in users %}
		     <option value="{{user.id}}" {% if user in lead_obj.assigned_to.all or user.id in assignedto_list %} selected="" {% endif %}> {{ user.first_name }} {{ user.last_name }} </option> 
		     {% endfor %}
		   </select>
		   {% endif %}
		 </div>
                 <div class="col-md-6">
	           <label for="exampleInputEmail1">Tags</label>
		   <div class="txt-box-div" id="tag-div"><input type="text" name="tags" id="id_tags_{{lead_record.domain.id}}"
		     value="{% for t in lead_record.tags.all %}{{t}}, {% endfor %}" class="tags tags_1" />
	         </div>
                </div>
	       </div>
               <br>
	       <div class="row marl buttons_row text-center form_btn_row">
	         <button  class="btn btn-default save" type="submit" id="submit_btn">Save</button>
		 <input type="hidden" name="domain" id="id_domain" value="{{ lead_record.domain.id}}">
               </div>
              </form>
            </div>
	  </div> 
          <br>
	  <br>
          <div class="card-body" id="datashow" style="margin: 0; padding: 0;">
                <div class="row marl">

                  <div class="col-md-4">

                    <div class="filter_col col-md-12" id="iname">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_ssl_expire" data-name="ssl_expire">SSL Expiration</label>
                        <div class="lead_field" id="lead_ssl_expire" data-name="ssl_expire"> 
				<h6><span class="badge badge-warning text-break text-wrap">{{ lead_record.domain.ssl_expire }}</span></h6>
			</div> 
		      </div>
                    </div>

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_ssl_issuer" data-name="ssl_issuer">SSL Issuer</label>
			<div class="lead_field">
			{% with lead_record.domain.ssl_issuer_name.all|first as ssl_issuer %}
			  {{ ssl_issuer }}
                        {% endwith %}	
			</div>
                      </div>
                    </div>

		    {% if lead_record.domain.ssl_issuer_org_unit %}
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_title" data-name="name">SSL Issuer Org Unit</label>
                        <div class="lead_field" id="lead_ssl_issuer_org" data-name="name">{{ lead_record.domain.ssl_issuer_org_unit }}</div>
                      </div>
                    </div>
		    {% endif %}

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_ssl_url" data-name="name">SSL URL</label>
                        {% if lead_record.domain.ssl_url %}
                        <div class="lead_field" id="lead_ssl_url" data-name="name">{{ lead_record.domain.ssl_url }}</div>
                        {% else %}
                        <div class="lead_field">Not specified</div>
                        {% endif %}
                      </div>
                    </div>

                  </div>
                  <div class="col-md-4">

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_email" data-name="name">Domain Expiration</label>
                        {% if lead_record.domain.domain_expire %}
                          <div class="lead_field" id="lead_email" data-name="name">{{ lead_record.domain.domain_expire }}</div>
                          {% else %}
                           <div class="lead_field">Not Specified</div>
                          {% endif %}
                      </div>
                    </div>

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_source" data-name="name">Domain Registrar</label>
                        {% if lead_record.domain.domain_registrar %}
                        <div class="lead_field" id="lead_source" data-name="name">{{ lead_record.domain.domain_registrar }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_website" data-name="name">Registrant Email</label>
                        {% if lead_record.domain.registrant_email %}
                        <div class="lead_field" id="lead_website" data-name="name">{{ lead_record.domain.registrant_email }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_website" data-name="name">Name Servers</label>
		        {% if lead_record.domain.name_servers.all|length > 0 %}
			<div class="lead_field">
			  {% for tag in lead_record.domain.name_servers.all %}
			  <h6><span class="badge badge-info text-break text-wrap">{{ tag.name }}</span></h6>
			  {% endfor %}
			</div>
			{% else %}
			<div class="lead_field">Not Specified</div>
			{% endif %} 
                      </div>
                    </div>
		  
		    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_website" data-name="name">MX Records</label>
			{% if lead_record.domain.mx_servers.all|length > 0 %}
			  <div class="lead_field">
                          {% for tag in lead_record.domain.mx_servers.all %}
                          <span class="badge badge-info text-break text-wrap">{{ tag.name }}</span>
                          {% endfor %}
                        </div>
                        {% else %}
			<div class="lead_field">Not Specified</div>
			{% endif %}
                      </div>
                    </div>
	      <!-- end column 2 -->	  
	      </div>
              <div class="col-md-4">

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_description" data-name="name">IP Address</label>
		        {% if lead_record.domain.site_ip %}
			<div class="lead_field" id="lead_description" data-name="name">{{ lead_record.domain.site_ip }}</div>
		        {% else %}
		        <div class="lead_field">Not Specified</div>
		        {% endif %}
                      </div>
                    </div>
                   
		     <div class="filter_col col-md-12">
                        <div class="form-group">
                          <label class="lead_field_label" for="id_website" data-name="name">Domain Profile</label>
			  {% if lead_record.domain.software_tags.all|length > 0 %}
			  <div class="lead_field">
			  {% for tag in lead_record.domain.software_tags.all %}
                          <span class="badge badge-info text-wrap text-break">{{ tag.name }}</span>
                          {% endfor %}
                          </div>
			  {% else %}
			  <div class="lead_field">Not Specified</div>
			  {% endif %}
                        </div>
		     </div>

                     <div class="filter_col col-md-12">
                        <div class="form-group">
                          <label class="lead_field_label" for="id_website" data-name="name">Running On</label>
			  {% if lead_record.domain.x_powered_by.all|length > 0 %}
                          <div class="lead_field">
                              {% for tag in lead_record.domain.x_powered_by.all %}
                              <span class="badge badge-info text-wrap text-break">{{ tag.name }}</span>
                              {% endfor %}
                          </div>
                          {% else %}
                          <div class="lead_field">Not Specified</div>
                          {% endif %}
                        </div>
                     </div>
                  </div>
                </div>
		<!-- </div> -->
            </div>
          </div>
        </div>
	<!--</div> -->

      <div class="modal-footer">
      <!-- insert comment forms -->
      <div class="col-md-12">
        <form id="comment_form{{lead_record.domain.id}}" method="POST" enctype="multipart/form-data">
          <div class="form-group ">
            <textarea class="form-control mentions" textarea cols="100" rows="3" id="id_comments{{lead_record.domain.id}}"
                      name="comment" placeholder="Leave Notes Here"></textarea>
            <div>
              <p id="CommentError{{lead_record.domain.id}}" style="display:none; color:red"></p>
            </div>
            <br>
            <div class="buttons_row text-center">
              <button class="btn btn-default save" style="text-align: center;"
                      id="comment_submit{{lead_record.domain.id}}">Submit</button>
            </div>
          </div>
          <input type="hidden" value="{{lead_record.domain.id}}" name="leadid">
        </form>
	<!-- end comment form -->
        
        <ul class="list-group" id="comments_div{{lead_record.domain.id}}">
        </ul>
      </div>
      <!-- end insert comment forms -->
      </div>

    </div>
    
  </div>
</div>


{% endfor %}


{% for lead_record in close_leads %}


<!-- modal for editing and deleting tags -->

<div class="modal fade bd-example-modal-lg modal_tags{{lead_record.id}}" tabindex="-1" role="dialog"
  aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="padding:20px 50px;">
        <h4><span class="glyphicon glyphicon-lock"></span>Update Tags</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px 50px;">
        <form role="form" id="" method="POST" action="{% url 'leads:update_lead_tags' lead_record.id %}">
          <div class="form-group">
            <label>Tags</label>
            <div class="txt-box-div" id="tag-div"><input type="text" name="tags" id="tags_1"
                value="{% for t in lead_record.tags.all %}{{t.name}}, {% endfor %}" class="tags tags_1" />
            </div>
          </div>
          <input type="hidden" name="full_path" value="{{request.get_full_path}}">
          <div class="text-center">
            <button id="" class="btn btn-success">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- modal for editing and deleting tags -->


<div class="modal fade" id="exampleModalCenter_lead{{lead_record.id}}" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">{{lead_record.title}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- ... -->
        <div class=" ">
          <div class="col-md-12" id="">
            <div class="card">

              <div class="card-body" id="datashow" style="margin: 0; padding: 0;">
                <div class="card-title text-right">
                  <h5>
                    <!-- <span class="float-left title">Overview</span> -->
                    <span class="" style="margin-top: 0px">
                      <div class="dropdown buttons_row">
                        <!-- <button class="btn primary_btn dropdown-toggle" type="button" data-toggle="dropdown">Actions
                            <span class="caret"></span></button> -->

                      </div>
                    </span>
                  </h5>
                </div>
                <div class="row marl">
                  <div class="col-md-4">
                    <div class="filter_col col-md-12" id="iname">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_name" data-name="name">Name</label>
                        <div class="lead_field" id="lead_name" data-name="name"> {% if lead_record.first_name  %}
                          {{ lead_record.first_name }}{% endif %} {% if lead_record.last_name  %}
                          {{ lead_record.last_name }}{% endif %}</div>
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_contact_account" data-name="name">Account Name</label>
                        {% if lead_record.account_name %}
                        <div class="lead_field" id="contact_account" data-name="name">{{ lead_record.account_name }}
                        </div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_title" data-name="name">Title</label>
                        {% if lead_record.title %}
                        <div class="lead_field" id="lead_title" data-name="name">{{ lead_record.title }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_phone" data-name="name">Phone</label>
                        {% if lead_record.phone %}
                        <div class="lead_field" id="lead_phone" data-name="name">{{ lead_record.phone }}</div>
                        {% else %}
                        <div class="lead_field">Not specified</div>
                        {% endif %}
                      </div>
                    </div>

                  </div>
                  <div class="col-md-4">
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_email" data-name="name">Email</label>
                        {% if lead_record.email %}
                        <div class="lead_field" id="lead_email" data-name="name">{{ lead_record.email }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_status" data-name="name">Status</label>
                        {% if lead_record.status %}
                        <div class="lead_field" id="lead_status" data-name="name">{{ lead_record.status }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_source" data-name="name">Source</label>
                        {% if lead_record.source %}
                        <div class="lead_field" id="lead_source" data-name="name">{{ lead_record.source }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_website" data-name="name">Website</label>
                        {% if lead_record.website %}
                        <div class="lead_field" id="lead_website" data-name="name">{{ lead_record.website }}</div>
                        {% else %}
                        <div class="lead_field">Not Specified</div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">

                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        {% if lead_record.address_line or lead_record.street or lead_record.city or lead_record.state or lead_record.postcode or lead_record.country %}
                        <label class="lead_field_label" for="id_address" data-name="name">Billing Address</label>
                        <div class="lead_field" id="lead_address" data-name="name">
                          {{lead_record.get_complete_address}}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    {% if lead_record.description %}
                    <div class="filter_col col-md-12">
                      <div class="form-group">
                        <label class="lead_field_label" for="id_description" data-name="name">Description</label>
                        <div class="lead_field" id="lead_description" data-name="name">{{ lead_record.description }}
                        </div>
                      </div>
                    </div>
                    {% endif %}
                    <div class="created_information">
                      Created by <b>{{ lead_record.created_by }}</b> created on <b
                        title="{{ lead_record.created_on }}">{{ lead_record.created_on_arrow }}</b>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
    <!-- <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div> -->
    </div>
  </div>
</div>

{% endfor %}

<div class="modal fade" id="uploadleadfile" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header justify-content-md-center">
        <h5 class="modal-title" id="exampleModalLabel">Upload Leads CSV</h5>
      </div>
      <div class="modal-body container-fluid">
        <div id="upload-ajax-ui">
	  <br>
	  <div class="text-center" id="lbl-upload-spiderjob-progress">
             <div class="fa-3x"><i class="fas fa-spider fa-spin"></i></div>
	     <label for="exampleInputEmail1">Cleaning lead data for upload ...</label>
          </div>

	  <br>
	  <div class="progress" id="track-upload-spiderjob-progress" style="height: 25px;">
          <!-- progress bar section -->
	    <div class="progress-bar progress-bar-striped bg-primary progress-bar-animated" id="track-upload-spiderjob-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="" aria-valuemin="0" aria-valuemax="100">
	    </div>
	  </div>
	  <!-- end progress bar section -->

	  <br>
	  <div class="text-center" id="lbl-upload-progress">
	    <label for="exampleInputEmail1"></label>
	  </div>

	  <br>
	  <div class="progress" id="upload-spiderjob-progress" style="height: 25px;">
	  <!-- progress bar section -->
	    <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" id="upload-spiderjob-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="" aria-valuemin="0" aria-valuemax="100">
            </div>
	  </div>
	  <!-- end progress bar section -->
	  <br>
        <!-- end upload-ajax-iu -->
	</div>

	<form id="frm_upload_csv" action="" method="POST" enctype="multipart/form-data">
	  <div class="filter_col col-md-12">
	    <div class="form-group">
	      <label>Leads File <span class="error">*</span>
              </label>
	      <input type="file" class="form-control-file" name="leads_file" accept=".csv" id="leads_file_input">
	    </div>
	  </div>

	  <div class="row justify-content-md-center d-none" id="upload_error">
	    <div class="col-md-12">
              <span class="error justify-content-md-center" id="span_upload_error"><i class="fa fa-exclamation-circle"></i></span>

	    </div>
          </div>

	  <div class="col-md-12">
	    <div class="row marl buttons_row text-center form_btn_row">
	      <button type="submit" class="btn btn-default save">Upload</button>
	      <button type="button" class="btn btn-default clear" data-dismiss="modal"
	         id="close_upload_form">Cancel</button>
	    </div>
	  </div>
	</form>

      </div>
    </div>
  </div>
</div>


{% endblock %}
{% block js_block %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-tagsinput/1.3.6/jquery.tagsinput.min.js"></script>
<script src="{% static 'js/ajaxForm.js' %}"></script>
<script type="text/javascript">

   // vars
   var prg_track_upload = $('#track-upload-spiderjob-progress-bar');
   var prg_upload = $('#upload-spiderjob-progress-bar');

  function wait(ms){
    var d = new Date();
    var d2 = null;
    do { d2 = new Date(); }
	  while(d2 - d < ms);
  }

  $(document).ready(function () {
    $('.name_servers').select2();
    $('#id_tag').select2();
    $('.lead_status_multi').select2();
    $('.assigned_sales').select2();
    $('#id_lead_status').select2();
    $('#tags_1').tagsInput({ width: 'auto' });
    $('.tags_1').tagsInput({ width: 'auto' });
    $('#upload-ajax-ui').hide()
    $(".filter_toggle").click(function () {
      $(".list_filter_row").toggle();
    });
    $('.remove_tag').hide()

  });

$("form[id^='lead_edit_form']").submit(function (e) {
	e.preventDefault();
	var lead_id = this.id.replace(/\D/g,'');
	var edit_url = 'http://35.155.172.235:8000/leads/' + lead_id + '/edit/';
	console.log('edit url: ' + edit_url);
	// data labels
	var name_lbl = 'lead_name' + lead_id;
	var phone_lbl = 'lead_phone' + lead_id;
	var email_lbl = 'lead_email' + lead_id;
	var tag_lbl = 'lead_tags' + lead_id;

	// form values
	var in_first_name = document.getElementById('id_first_name'+lead_id).value;
	var in_last_name = document.getElementById('id_last_name'+lead_id).value;
	var in_phone = document.getElementById('id_phone'+lead_id).value;
	var in_email = document.getElementById('id_email'+lead_id).value;
	var in_tags = document.getElementById('id_tags_'+lead_id).value;
	console.log(in_tags);

	$.ajax({
		url: edit_url,
		type: "POST",
		dataType:'json',
		data: $('#lead_edit_form'+lead_id).serialize(),
		success: function (data) {
		    if (data.error) {
			console.log(data.error);
		    } else {
			// collapse
			$('#collapse_edit_lead'+lead_id).collapse('hide');
			// update name label
			if (in_first_name != "" && in_last_name != ""){
			    document.getElementById(name_lbl).innerHTML = in_first_name + " " + in_last_name;
			} else if (in_first_name != "") {
			    document.getElementById(name_lbl).innerHTML = in_first_name;
			} else if (in_last_name != "") {
			    document.getElementById(name_lbl).innerHTML = in_last_name;
			}
			// update phone label
			if (in_phone != "") {
			    document.getElementById(phone_lbl).innerHTML = in_phone;
			}
			// update email label
			if (in_email != ""){
			    document.getElementById(email_lbl).innerHTML = in_email;
			}

			document.getElementById(tag_lbl).innerHTML = "";

	                if (in_tags != ""){
				document.getElementById(tag_lbl).innerHTML = "<hr/> ";
                                var tag_arr = in_tags.split(',');
				tag_arr.forEach(function(entry) {
					document.getElementById(tag_lbl).innerHTML += '<span class="badge badge-success">' + entry + '</span> ';
				});
	                }

			if (in_tags == ""){
				document.getElementById(tag_lbl).innerHTML = "<hr/>";
			}
	        
		    }
		}
	});
	return false;
});


  function remove_comment(x) {
    const con = confirm("Delete note?");
    if (con == true) {
      $.post('{% url "leads:remove_comment" %}', {
	"comment_id": x
      }, function (data) {
	if (data.error) {
	  alert(data.error)
        } else {
	  $("#comment" + data.cid).remove()
	}
       })
    }
  }

function edit_comment(com_id) {

    var div_id = "comment_name" + com_id;
    var com_div = document.getElementById(div_id);
    var com_txt = com_div.textContent;
    var id_hidden = "pre_leadid_" + com_id;
    var lead_input = document.getElementById(id_hidden);

    var lead_id = lead_input.value;

    var fd = new FormData();
    fd.append('commentid', com_id);
    fd.append('leadid', lead_id);

    var confirm_edit = prompt("Edit Note", com_txt);

    if (confirm_edit != null && confirm_edit != ""){

       fd.append('comment', confirm_edit);

       $.ajax({
         url: "{% url 'leads:edit_comment' %}",
         type: "POST",
	 data: fd,
         cache: false,
         contentType: false,
         processData: false,
         success: function (data) {
           if (data.error) {
             $("#CommentEditError").html(data.error).show()
           } else {
             $("#comment_name" + data.commentid).html('<pre>' + data.comment + '</pre>');
           }
         }
       });
       return false;
    }
}


$( "div[id^='exampleModalCenter_lead']" ).on('hidden.bs.modal', function (e) {
    // grab hide modal event 
    var lead_id = this.id.replace(/\D/g,'');
    console.log(lead_id);
    var target_mod = "#comments_div" + lead_id;
    console.log(target_mod);
    $(target_mod).empty();
  });


  $( "div[id^='exampleModalCenter_lead']" ).on('show.bs.modal', function (e) {
    // grab open modal event and pull comments
    var lead_id = this.id.replace(/\D/g,'');
    //alert(lead_id);
    
    $.ajax({
      url: "http://35.155.172.235:8000/leads/get/comments?leadid="+lead_id,
      type: "GET",
      dataType: "json",
      cache: false,
      beforeSend: function () {
        // $('#loading_spinner').show();
        // $('#opacity_block').addClass('opacity_block');
      },
      success: function (data) {
	console.log(data);
	// prep id var for modal identifier
        var target_mod = "#comments_div" + lead_id;

	//let note_num = $(target_mod).innerHTML;
	//alert(note_num)
	console.log(target_mod);
	// run for-each on json object array

	      data.forEach(function(item, index){

		  // create Date obj from obj timestamp
                  d = new Date(item.commented_on);
		  let options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  };
                  d = d.toLocaleString('en-us', options);
  
		  var notes_div = $(target_mod);

		  // prepend comment html to modal footer
                  notes_div.prepend(
			  "<li class='list-group-item list-row' id='comment" + item.comment_id + "'>" +
                          "<div class='float-right right-container'>" +
                          "<div class='list-row-buttons btn-group float-right'>" +
                          "<button class='btn primary_btn btn-sm dropdown-toggle' data-toggle='dropdown' type='button'><span class='caret'></span>Actions</button>" +
                          "<ul style='width: fit-content; min-width: -webkit-fill-available;' class='dropdown-menu text-center'>" +
                          "<li><a style='padding: 0.5em; background: #17a2b8; color:white; font-weight: 600;' class='action' onclick='edit_comment(" + item.comment_id + ")'>Edit</a></li>" +
                          "<li><a style='padding: 0.5em; background: #17a2b8; color:white; font-weight: 600;' class='action' onclick='remove_comment(" + item.comment_id + ")'>Remove</a></li></ul></div></div>" +
                         "<input id='pre_leadid_" + item.comment_id + "' type='hidden' value='" + item.lead_id + "'>" +
                         "<div class='stream-post-container' id='comment_name" + item.comment_id + "'><pre>" + item.comment + "</pre></div>" +
                         "<div class='stream-container'><pre class='float-left'>" + item.commented_by + "</pre><pre class='float-right' title='" + d.toLocaleString('en-US', { hour12: true }) + "'>" +
                         item.commented_on_arrow + "</pre></div>" +
                         "<div class='stream-date-container' id='comment_file_div" + item.comment_id + "'><div id='new_comment" + item.comment_id + "'</div></div></li>"
			 )


	      }); // end forEach

      } // end ajax.success
    })

  });


  $("form[id^='comment_form']" ).submit(function (e) {
    e.preventDefault()
    var lead_id = this.id.replace(/\D/g,'');
    
    const formData = new FormData($("#comment_form"+lead_id)[0]);
    $.ajax({
      url: "{% url 'leads:add_comment' %}",
      type: "POST",
      data: formData,
      cache: false,
      contentType: false,
      processData: false,
      success: function (data) {
        if (data.error) {
	$("#CommentError").html(data.error).show()
        } else {
          d = new Date(data.commented_on);
          let options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          };
          d = d.toLocaleString('en-us', options);

          var target_mod = "#comments_div" + lead_id;
	  var notes_textarea = "#id_comments" + lead_id;

	  var notes_div = $(target_mod);
	  var textarea_div = $(notes_textarea);

          notes_div.prepend("<li class='list-group-item list-row' id='comment" + data.comment_id + "'>" +
            "<div class='float-right right-container'>" +
            "<div class='list-row-buttons btn-group float-right'>" +
            "<button class='btn primary_btn btn-sm dropdown-toggle' data-toggle='dropdown' type='button'><span class='caret'></span>Actions</button>" +
            "<ul style='width: fit-content; min-width: -webkit-fill-available;' class='dropdown-menu text-center'>" +
            "<li><a style='padding: 0.5em; background: #17a2b8; color:white; font-weight: 600;' class='action' onclick='edit_comment(" + data.comment_id + ")'>Edit</a></li>" +
            "<li><a style='padding: 0.5em; background: #17a2b8; color:white; font-weight: 600;' class='action' onclick='remove_comment(" + data.comment_id + ")'>Remove</a></li></ul></div></div>" +
	    "<input id='pre_leadid_" + data.comment_id + "' type='hidden' value='" + data.lead_id + "'>" +
	    "<div class='stream-post-container' id='comment_name" + data.comment_id + "'><pre>" + data.comment + "</pre></div>" +
            "<div class='stream-container'><pre class='float-left'>" + data.commented_by + "</pre><pre class='float-right' title='" + d.toLocaleString('en-US', { hour12: true }) + "'>" + data.commented_on_arrow + "</pre></div>" +
            "<div class='stream-date-container' id='comment_file_div" + data.comment_id + "'><div id='new_comment" + data.comment_id + "'</div></div></li>"
          );
	  textarea_div.val("");
          alert("Note Saved");
	  $("#CommentError").html("")
        }
      }
    }) 
  });



  $("#uploadleadfile").on("hidden.bs.modal", function () {
    // put your default event here
    $('p.failure').remove();
    if ($('#upload_error').hasClass('d-none')) {	  
      $('#upload_error').removeClass('d-none');
    }
    $('#leads_file_input').val('');
    $('#upload-ajax-ui').hide()
  });

  $(".tag_class_lead_").hover(
    function () {
      $('.remove_tag').hide()
      $(this).find(".remove_tag").show();
    },
    function () {
      $(this).find('.remove_tag').hide();
    });

  $(".tag_class_lead").click(function () {
    // $(".tag_class_opp").css('cursor', 'pointer')
    url = "{% url 'leads:list' %}"
    url = url + "?tag=" + $(this).attr('data-link')
    window.location.href = url;
  });

  $(".remove_tag").click(function () {
    // $(".tag_class_opp").css('cursor', 'pointer')
    url = "{% url 'leads:list' %}"
    console.log($(this).attr('data-tag'))
    console.log($(this).attr('data-lead'))
    const data = { 'tag': $(this).attr('data-tag'), 'lead': $(this).attr('data-lead') }
    const tagToRemove = $(this).attr('data-lead') + $(this).attr('data-tag')
    const lead = $(this).attr('data-lead')
    $.ajax({
      url: "{% url 'leads:remove_lead_tag' %}",
      type: "POST",
      data: data,
      beforeSend: function () {
        // $('#loading_spinner').show()
        // $('#opacity_block').addClass('opacity_block')
      },
      success: function (data) {
        if (data.error) {
          alert(data.error)
        } else {
          // TODO remove the tag based on attributes
          $('[data-leadTag="' + tagToRemove + '"]').remove()
          if ($(('#leadtag' + lead) + '> span').length < 1) {
            $('#leadtag' + lead).html('No Tags')
          }
          setTimeout(() => {
            alert("Tag Removed")
          }, 100);
        }
      }
    })


    // url = url + "?tag=" + $(this).attr('data-link')
    // window.location.href = url;
  });

  search = "{{search}}"

  $('#uploadleadfile').ajaxForm({
    type: 'POST',
    dataType: 'json',
    url: "{% url 'leads:upload_lead_csv_file' %}",
    data: $(this).serialize(),
    beforeSend: function () {
      $('#cover_screen').addClass('add_opacity');
    },
    success: function (data) {
      console.log('-- inside #uploadleadfile. success --');	    
      console.log(data);	    
      if (data.task_id != null) {
	console.log('-- data.task_id != null, passing to get_upload_info() --')
	$('#frm_upload_csv').hide();
	$('#upload-ajax-ui').show();
	// call ajax for updating progress bars
	get_upload_info(data.task_id);
        
      } else {
	console.log('-- data.task_id IS NULL, ERROR--');
        /*$(document).ajaxStop($.unblockUI);*/
        // $.unblockUI();
        $('p.failure').remove();
	$('#upload_error').removeClass('d-none');
        for (var key in data.errors) {
          $('#span_upload_error').html('<p class="error failure"> *' + data.errors[key] + '</p>');
          $('#cover_screen').removeClass('add_opacity')

        }
      }
    },
    error: function (xhr, errmsg, err) {
      console.log('error data', errmsg, err)
    }
  });


  function get_upload_info(task_id) {
	      console.log("-- inside get_upload_info");

	      $.ajax({
	          type: 'get',
		  url: "{% url 'leads:upload_lead_csv_file' %}",
		  data: {'task_id': task_id},
		  success: function (data) {
		      if (data.state == 'PENDING') {
		          console.log(" -- success: PENDING ..");
		      }
		      else if (data.state == 'PROGRESS' || data.state == 'SUCCESS') {
		          //console.log('-- job still in progress or successful');
			  console.log("-- data.result.import_status --");
			  console.log(data.result.import_status);
			  console.log("-- data.current_domain_progress --");
			  console.log(data.result.current_domain_progress);
			  console.log("-- data.result.current_domain --");
			  console.log(data.result.current_domain);
			  console.log("-- data.total_domains --");
			  console.log(data.result.total_domains);

			  console.log("-- data.spiderjob_label --");
			  console.log(data.result.spiderjob_label);

			  console.log("-- data.spiderjob_progress --");
			  console.log(data.result.spiderjob_progress);

			  prg_upload.css('width', data.result.current_domain_progress);
			  prg_track_upload.css('width', data.result.spiderjob_progress);

			  import_text = data.result.import_status + data.result.current_domain

                          track_text = data.result.domain_count + " of " + data.result.total_domains

			  console.log("-- track_text --");
			  console.log(track_text);

			  $('#lbl-upload-spiderjob-progress label').text(import_text);
			  $('#lbl-upload-progress label').text(track_text);

			  if (data.result.import_status == '-- Lead uploads complete --'){
			      $('#uploadleadfile').modal('hide');
                              wait(1500);
			      location.reload(true);
			  }
                 
		      }

	              if (data.state != 'SUCCESS') {
	                  console.log(" -- continuing with async task on Celery ..");
			      setTimeout(function () {
			          get_upload_info(task_id);
				}, 250);
		      }
	        },
		error: function (data) {
                    // need to add some kind of feedback for error reporting
	            console.log(" -- error: something happened on SpiderJob Import ..");
		}
	});

  }

  if (search == 'True') {
    $(".list_filter_row").show();
  }

  $("#close-tab").click(function (e) {
    $("#tab_status").val('Closed')
  })

  $("#open-tab").click(function (e) {
    $("#tab_status").val('Open')
  })

  tab_status = "{{tab_status}}"
  if (tab_status == 'Closed') {
    $("#close-tab").click()
  } else {
    $("#open-tab").click()
  }

  $('.delete').click(function (e) {
    e.preventDefault()
    url = $(this).attr('href')
    if (!confirm('Are you sure you want to delete?'))
      return;
    window.location = $(this).attr('href')
  });

  $("a[rel='page']").click(function (e) {
    e.preventDefault();
    $('#leads_filter').attr("action", $(this).attr("href"));
    $('#leads_filter').submit();
  });

  $(function () {
     var date = new Date();
     var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      $('#id_domain_expire_from').datetimepicker({
          'format': 'YYYY-MM-DD',
      })
  });

  $(function () {
     var date = new Date();
     var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      $('#id_domain_expire_to').datetimepicker({
          'format': 'YYYY-MM-DD',
      })
  });

  $(function () {
     var date = new Date();
     var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      $('#id_ssl_expire_from').datetimepicker({
          'format': 'YYYY-MM-DD',
      })
    });

  $(function () {
     var date = new Date();
     var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
     $('#id_ssl_expire_to').datetimepicker({
          'format': 'YYYY-MM-DD',
      })
    });
</script>
{% endblock %}





